
import React, { useState, useRef } from 'react';
import { ScanReport } from '../types';
import { Database, FileJson, Loader2, FileText, Printer, FileCode, ShieldCheck, Download, Zap, ShieldAlert, Cpu, Lock, Terminal, Shield, UserCheck } from 'lucide-react';

interface ReportViewProps {
  report: ScanReport | null;
}

const ReportView: React.FC<ReportViewProps> = ({ report }) => {
  const [isExporting, setIsExporting] = useState<string | null>(null);
  const pdfRef = useRef<HTMLDivElement>(null);

  // 辅助函数：确保 IP 地址中的点是标准半角点
  const formatIP = (ip: string) => {
    if (!ip) return '';
    return ip.replace(/。/g, '.').replace(/．/g, '.').trim();
  };

  const downloadPdf = () => {
    if (!report || !pdfRef.current) return;
    setIsExporting('PDF');

    const element = pdfRef.current;
    const sanitizedIp = formatIP(report.target).replace(/\./g, '_');
    
    const opt = {
      margin: [10, 10, 10, 10],
      filename: `NetAudit_Report_${sanitizedIp}_${new Date().getTime()}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2, 
        useCORS: true, 
        backgroundColor: '#ffffff',
        letterRendering: true
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // @ts-ignore
    window.html2pdf().set(opt).from(element).save().then(() => {
      setIsExporting(null);
    });
  };

  const downloadMarkdown = () => {
    if (!report) return;
    setIsExporting('MD');

    const m = report.metadata || { assetName: '未命名资产', securityLevel: '三级', location: '未知', evaluator: '未知' };
    const targetIp = formatIP(report.target);

    const mdContent = `
# 网络安全技术审计报告 (NetAudit Pro)

## 1. 测评对象基本信息
- **设备名称**: ${m.assetName}
- **等保等级**: ${m.securityLevel}
- **物理位置**: ${m.location}
- **审计负责人**: ${m.evaluator}
- **目标 IP**: ${targetIp}
- **审计时间**: ${report.timestamp}

## 2. 审计结论与评分
**安全得分**: ${report.score} / 100
**风险概览**: 高危(${report.summary.high}) 中危(${report.summary.medium}) 低危(${report.summary.low})

---

## 3. 合规缺陷详情
${report.defects.map(d => `
### [${d.risk_level}] ${d.check_item}
- **涉及条款**: ${d.mlps_clause}
- **风险描述**: ${d.description}
- **建议措施**: ${d.suggestion}
`).join('\n')}

---

## 4. 资产端口画像
${report.port_statuses.map(p => `- Port ${p.port} (${p.protocol}): ${p.detail}`).join('\n')}

---
*Generated by NetAudit Pro v3.1 (STABLE)*
    `.trim();

    const blob = new Blob([mdContent], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `NetAudit_${targetIp.replace(/\./g, '_')}.md`;
    a.click();
    setIsExporting(null);
  };

  const exportToJson = () => {
    if (!report) return;
    setIsExporting('JSON');
    const sanitizedIp = formatIP(report.target).replace(/\./g, '_');
    
    setTimeout(() => {
      const dataStr = JSON.stringify(report, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', `NetAudit_${sanitizedIp}.json`);
      linkElement.click();
      setIsExporting(null);
    }, 500);
  };

  if (!report) {
    return (
      <div className="flex flex-col items-center justify-center h-[600px] tactical-card rounded-[4rem] border-dashed border-white/5 relative overflow-hidden bg-black/20">
        <Database size={48} className="text-white/10 mb-6 animate-pulse" />
        <span className="text-xs font-black uppercase tracking-[0.5em] text-white/20 italic">报告归档库空置</span>
      </div>
    );
  }

  const meta = report.metadata || { assetName: '未命名资产', securityLevel: '三级', location: '未知', evaluator: '未知' };

  return (
    <div className="space-y-12 animate-in fade-in duration-1000 max-w-5xl mx-auto pb-20">
      <div className="tactical-card rounded-[3.5rem] border border-white/10 overflow-hidden relative group shadow-2xl">
        <div className="absolute inset-0 scanline-container opacity-10 pointer-events-none"></div>
        
        <div className="p-12 md:p-16 flex flex-col items-center text-center relative z-10">
          <div className="w-24 h-24 bg-brand/10 border border-brand/20 rounded-3xl flex items-center justify-center mb-10 shadow-xl">
            <ShieldCheck size={50} className="text-brand" />
          </div>
          
          <h2 className="text-6xl font-black italic uppercase tracking-tighter glow-text mb-2">档案导出终端</h2>
          <p className="text-[10px] font-bold text-white/20 uppercase tracking-[0.6em] mb-12">DEEP ARCHIVE EXPORT TERMINAL</p>

          <div className="w-full max-w-3xl grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
              <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-left">
                  <span className="text-[8px] font-black text-white/20 uppercase block mb-1">设备名称</span>
                  <span className="text-xs font-bold text-white truncate block">{meta.assetName}</span>
              </div>
              <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-left">
                  <span className="text-[8px] font-black text-white/20 uppercase block mb-1">等保等级</span>
                  <span className="text-xs font-bold text-brand block">{meta.securityLevel}</span>
              </div>
              <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-left">
                  <span className="text-[8px] font-black text-white/20 uppercase block mb-1">物理位置</span>
                  <span className="text-xs font-bold text-white/60 truncate block">{meta.location}</span>
              </div>
              <div className="bg-white/5 p-4 rounded-2xl border border-white/5 text-left">
                  <span className="text-[8px] font-black text-white/20 uppercase block mb-1">测评员</span>
                  <span className="text-xs font-bold text-info block">{meta.evaluator}</span>
              </div>
          </div>

          <div className="flex flex-wrap justify-center gap-6 w-full">
             <button onClick={downloadPdf} disabled={!!isExporting} className="group relative px-10 py-6 bg-white text-black rounded-2xl font-black uppercase italic text-sm flex items-center gap-4 hover:bg-brand transition-all disabled:opacity-50 min-w-[260px]">
               {isExporting === 'PDF' ? <Loader2 size={20} className="animate-spin" /> : <Printer size={20} />}
               <div className="text-left">
                 <span className="block leading-none">下载合规 PDF</span>
                 <span className="text-[8px] opacity-60 font-bold block mt-1 tracking-widest uppercase">Standard Audit Format</span>
               </div>
             </button>
             <button onClick={downloadMarkdown} disabled={!!isExporting} className="px-10 py-6 bg-white/5 border border-white/10 text-white rounded-2xl font-black uppercase italic text-sm flex items-center gap-4 hover:bg-white/10 transition-all min-w-[260px]">
               {isExporting === 'MD' ? <Loader2 size={20} className="animate-spin" /> : <FileCode size={20} className="text-info" />}
               <div className="text-left">
                 <span className="block leading-none">导出 Markdown</span>
                 <span className="text-[8px] opacity-40 font-bold block mt-1 tracking-widest uppercase">Security Document</span>
               </div>
             </button>
             <button onClick={exportToJson} disabled={!!isExporting} className="px-10 py-6 bg-white/5 border border-white/10 text-white rounded-2xl font-black uppercase italic text-sm flex items-center gap-4 hover:bg-white/10 transition-all min-w-[260px]">
               {isExporting === 'JSON' ? <Loader2 size={20} className="animate-spin" /> : <FileJson size={20} className="text-brand" />}
               <div className="text-left">
                 <span className="block leading-none">JSON 数据流</span>
                 <span className="text-[8px] opacity-40 font-bold block mt-1 tracking-widest uppercase">System Raw Data</span>
               </div>
             </button>
          </div>
        </div>
      </div>

      {/* 隐藏的 PDF 模板：极致优化版 */}
      <div className="fixed -left-[5000px] top-0 pointer-events-none">
        <div ref={pdfRef} className="w-[210mm] bg-white text-black p-14 font-sans leading-normal">
          {/* 页眉装饰线 */}
          <div className="flex justify-between items-center border-b-2 border-black pb-3 mb-10">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-black text-white flex items-center justify-center rounded">
                <Terminal size={18} />
              </div>
              <span className="text-[11px] font-black uppercase tracking-tighter">NetAudit Secure Terminal | GB/T 22239 对标</span>
            </div>
            <div className="text-right">
              <span className="text-[10px] font-bold text-gray-400 block">INTERNAL CONFIDENTIAL</span>
              <span className="text-[9px] font-mono text-gray-400">导出时间: {report.timestamp}</span>
            </div>
          </div>

          {/* 标题区 */}
          <div className="mb-12">
            <h1 className="text-4xl font-black uppercase tracking-tight mb-2">网络安全技术审计报告</h1>
            <div className="flex items-center gap-4 text-gray-500">
               <div className="px-2 py-0.5 border border-gray-300 rounded text-[9px] font-bold">测评资产背景已校验</div>
               <div className="text-[10px] font-bold uppercase tracking-widest">REPORT HASH: {Math.random().toString(16).substr(2, 8).toUpperCase()}</div>
            </div>
          </div>
          
          {/* 核心结论勋章与资产模板数据 */}
          <div className="flex gap-10 mb-12 bg-gray-50 p-8 rounded-2xl border border-gray-100">
             <div className="flex flex-col items-center justify-center border-r border-gray-200 pr-10">
                <div className="text-[10px] font-black text-gray-400 uppercase mb-2">安全综合评分</div>
                <div className={`text-6xl font-black ${report.score > 80 ? 'text-green-600' : report.score > 60 ? 'text-orange-500' : 'text-red-600'}`}>
                  {report.score}
                </div>
                <div className="text-[10px] font-bold text-gray-500 mt-2 italic">SCORE / 100</div>
             </div>
             <div className="flex-1 space-y-4">
                <div className="text-[10px] font-black text-gray-400 uppercase">1. 审计资产画像 (Asset Profile)</div>
                <div className="grid grid-cols-2 gap-x-6 gap-y-5">
                   <div>
                      <div className="text-[8px] text-gray-400 uppercase font-black tracking-widest">设备/系统名称</div>
                      <div className="text-sm font-black border-b border-gray-100 pb-1">{meta.assetName}</div>
                   </div>
                   <div>
                      <div className="text-[8px] text-gray-400 uppercase font-black tracking-widest">目标 IP 地址</div>
                      <div className="text-sm font-mono font-bold border-b border-gray-100 pb-1" style={{ fontFamily: '"Courier New", Courier, monospace', letterSpacing: '-0.3px', fontVariantNumeric: 'tabular-nums' }}>
                        {formatIP(report.target)}
                      </div>
                   </div>
                   <div>
                      <div className="text-[8px] text-gray-400 uppercase font-black tracking-widest">等级保护等级</div>
                      <div className="text-sm font-black border-b border-gray-100 pb-1">{meta.securityLevel} (标准)</div>
                   </div>
                   <div>
                      <div className="text-[8px] text-gray-400 uppercase font-black tracking-widest">资产负责人 (审计员)</div>
                      <div className="text-sm font-black border-b border-gray-100 pb-1 text-blue-700">{meta.evaluator}</div>
                   </div>
                   <div className="col-span-2">
                      <div className="text-[8px] text-gray-400 uppercase font-black tracking-widest">物理存储/机房位置</div>
                      <div className="text-sm font-black border-b border-gray-100 pb-1">{meta.location}</div>
                   </div>
                </div>
             </div>
          </div>

          {/* 合规缺陷清单 */}
          <h2 className="text-xs font-black uppercase mb-6 text-gray-800 flex items-center gap-2">
            <ShieldAlert size={14} /> 2. 技术合规缺陷清单 (Compliance Findings)
          </h2>
          <div className="space-y-6 mb-12">
            {report.defects.length === 0 ? (
              <div className="p-10 border-2 border-dashed border-gray-100 rounded-xl text-center">
                 <ShieldCheck size={40} className="text-green-500 mx-auto mb-4" />
                 <p className="text-xs font-bold text-gray-400 uppercase tracking-[0.2em]">资产合规：未发现已知安全风险点</p>
              </div>
            ) : report.defects.map((d, i) => (
              <div key={i} className="border border-gray-200 rounded-xl overflow-hidden">
                <div className={`px-4 py-2 flex justify-between items-center ${d.risk_level === '高危' ? 'bg-red-600 text-white' : d.risk_level === '中危' ? 'bg-orange-500 text-white' : 'bg-gray-800 text-white'}`}>
                    <div className="flex items-center gap-3">
                       <span className="text-[8px] font-black uppercase tracking-widest px-2 py-0.5 bg-white/20 rounded">FINDING #{String(i+1).padStart(2, '0')}</span>
                       <h4 className="font-black text-[11px] uppercase tracking-tight">{d.check_item}</h4>
                    </div>
                    <span className="text-[9px] font-black uppercase italic">{d.risk_level}</span>
                </div>
                <div className="p-4 bg-white grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                     <div className="text-[8px] font-bold text-gray-400 uppercase tracking-tighter">GB/T 22239 条款: {d.mlps_clause}</div>
                     <p className="text-[10px] text-gray-600 leading-relaxed italic">{d.description}</p>
                  </div>
                  <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                     <div className="text-[8px] font-black text-gray-400 uppercase mb-1">建议加固措施 (Remediation):</div>
                     <p className="text-[10px] text-gray-700 font-bold leading-relaxed">{d.suggestion}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* 网络拓扑画像 */}
          <h2 className="text-xs font-black uppercase mb-6 text-gray-800 flex items-center gap-2">
            <Zap size={14} /> 3. 服务指纹与暴露面 (Port Scans)
          </h2>
          <table className="w-full border-collapse text-[9px] mb-12">
             <thead>
                <tr className="bg-gray-100">
                   <th className="border border-gray-200 p-3 text-left font-black">通信端口</th>
                   <th className="border border-gray-200 p-3 text-left font-black">协议</th>
                   <th className="border border-gray-200 p-3 text-left font-black">状态</th>
                   <th className="border border-gray-200 p-3 text-left font-black">指纹/Banner 摘要</th>
                </tr>
             </thead>
             <tbody>
                {report.port_statuses.map((p, i) => (
                   <tr key={i}>
                      <td className="border border-gray-200 p-3 font-bold">{p.port}</td>
                      <td className="border border-gray-200 p-3 font-bold uppercase">{p.protocol}</td>
                      <td className="border border-gray-200 p-3 text-green-600 font-bold">OPEN/ACTIVE</td>
                      <td className="border border-gray-200 p-3 text-gray-500 font-mono italic">{p.detail}</td>
                   </tr>
                ))}
             </tbody>
          </table>

          {/* 页脚 */}
          <div className="mt-20 pt-8 border-t border-gray-100 text-center relative">
             <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-4">
                <Shield size={24} className="text-gray-200" />
             </div>
             <div className="text-[9px] text-gray-300 font-black uppercase tracking-[0.4em] mb-2">NetAudit Pro v3.1 Security Engine</div>
             <p className="text-[8px] text-gray-400 max-w-sm mx-auto leading-relaxed">
                本报告由离线节点自动生成。审计结论仅对当前快照有效。涉及资产信息 ( {meta.assetName} ) 仅供企业内部合规自测使用。
             </p>
             <div className="mt-4 text-[7px] text-gray-200 font-mono uppercase">
               AUTH_NODE: {window.location.hostname} | REPORT_SIGNATURE: {btoa(report.timestamp).substr(0, 16)}
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ReportView;
